apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: mpi
spec:
  slotsPerWorker: 1
  runPolicy:
    cleanPodPolicy: Running
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        spec:
          containers:
            - image: arthurstupa/mnist-detector:latest
              name: mnist-launcher
              env:
              - name: DATA_PATH
                value: /app/data
              - name: WANDB_API_KEY
                valueFrom:
                  secretKeyRef:
                    name: wandb-secret
                    key: WANDB_API_KEY
              command:
              - bash
              - -c
              - |
                export MASTER_ADDR=$(awk 'NR==1{print $1}' /etc/mpi/hostfile)

                echo "Launcher using MASTER_ADDR=$MASTER_ADDR"

                mpirun --allow-run-as-root \
                  --tag-output \
                  -mca plm_rsh_args "-o StrictHostKeyChecking=no" \
                  -x MASTER_ADDR \
                  -x DATA_PATH \
                  -x WANDB_API_KEY \
                  python train.py

    Worker:
      replicas: 1
      template:
        spec:
          containers:
            - image: arthurstupa/mnist-detector:latest
              name: mnist-worker
              volumeMounts:
              - name: dataset
                mountPath: /app/data
          volumes:
          - name: dataset
            persistentVolumeClaim:
              claimName: mnist-pvc
